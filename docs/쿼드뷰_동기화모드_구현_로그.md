# 쿼드뷰·동기화 모드 구현 로그

쿼드뷰(2×2 패널) 및 동기화 모드 구현 과정을 단계별로 기록한다.

---

##### 1. viewerStore 확장

- **추가 상태:** `syncMode: boolean` (기본 false), `focusedPanelIndex: number | null`.
- **추가 액션:** `setSyncMode(on)`, `setFocusedPanel(index)`.
- **파일:** `src/stores/viewerStore.ts`.

##### 2. WSIViewer 확장

- **optional props:** `showScale` (기본 true), `onFocus`, `onPan`, `onZoom`, `onTileLoaded`, `width`, `height`.
- **배율 표시:** `showScale === true`일 때만 상단 배율·중심 좌표 표시.
- **forwardRef + useImperativeHandle:** `getViewport()` 노출. 반환값: `{ panBy, getCenter, getZoom, zoomTo, panTo } | null`.
- **포커스/동기화:** `canvas-scroll`, `zoom`, `pan` 핸들러에서 `onFocus`/`onZoom`/`onPan` 호출.
- **onTileLoaded:** OSD `tile-loaded` 이벤트에서 `onTileLoaded(slideId)` 호출.
- **파일:** `src/components/WSIViewer.tsx`.

##### 3. QuadView 컴포넌트

- **역할:** 2×2 그리드, 패널마다 슬라이드 드롭다운 + 닫기, 동기화 모드 토글, 4개 WSIViewer ref로 pan/zoom 동기화.
- **props:** `panelSlots`, `setPanelSlot`, `slides`, `slideInfos`(길이 4), `markers`, `tumorAreas`.
- **동기화 ON 시:** `useEffect([syncMode])`로 좌상단(0) 뷰포트의 zoom/center를 읽어 나머지 3뷰에 `zoomTo` + `panTo` 적용.
- **pan 동기화:** `lastCenterRef`에 이전 중심 저장, pan 시 delta 계산 후 나머지 3뷰 `panBy(delta)`.
- **zoom 동기화:** zoom 발생 뷰의 `getZoom(true)`로 나머지 3뷰 `zoomTo(zoom, 각자 getCenter(true))`.
- **배율 표시:** `focusedPanelIndex === panelIndex`일 때만 해당 패널에 `showScale={true}`.
- **파일:** `src/components/QuadView.tsx`.

##### 4. App 통합

- **뷰 모드 드롭다운:** 상단에 "단일 뷰 모드" / "쿼드뷰 모드" 선택. 상태 `viewMode: 'single' | 'quad'`.
- **panelSlots:** `(string | null)[]` 길이 4, `setPanelSlot(index, slideId | null)`.
- **패널별 slideInfo:** `useQueries`로 4개 슬롯에 대해 `fetchSlideInfo` 호출(해당 슬롯이 non-null일 때만 enabled).
- **쿼드뷰 시:** `QuadView`에 `panelSlots`, `setPanelSlot`, `slides`, `slideInfos`, `markers`, `tumorAreas` 전달.
- **파일:** `src/App.tsx`.

##### 5. 쿼드뷰 2개 이상 슬라이드 시 리렌더링/미표시 수정

- **원인:** QuadView에서 ref 콜백과 onFocus/onPan/onZoom을 매 렌더마다 새로 넘기면, WSIViewer의 useEffect 의존이 바뀌어 OSD가 반복 파괴·재생성됨.
- **조치:** 패널당 고정 ref 4개(`ref0`~`ref3`) 사용, `ref={viewerRefs[panelIndex]}`로 동일 ref 객체 유지. onFocus/onPan/onZoom은 패널별 `useCallback`(onFocus0~3, onPan0~3, onZoom0~3)으로 고정 참조 전달.
- **파일:** `src/components/QuadView.tsx`.

##### 5-1. 동기화 모드 진입 시 동일 현상 재현 수정

- **원인:** 동기화 모드 체크 시 `syncMode` 변경 → QuadView 리렌더 → `syncPanFrom`/`syncZoomFrom`이 `[syncMode]` 의존으로 새 참조 → `onPan0`~`onZoom3` 새 참조 → WSIViewer에 전달되는 onFocus/onPan/onZoom 변경 → WSIViewer의 OSD 생성 effect 의존 배열에 이들이 포함되어 effect 재실행 → OSD destroy 후 재생성.
- **조치:** WSIViewer에서 onFocus/onPan/onZoom/onTileLoaded를 effect 의존 배열에서 제거. ref(`onFocusRef` 등)에 매 렌더 시 최신 콜백을 넣고, OSD 핸들러에서는 ref를 통해 호출(`onFocusRef.current?.()`). effect 의존은 `[slideId, slideInfo, syncViewport]`만 유지해 동기화 모드 토글 시 OSD가 재생성되지 않도록 함.
- **파일:** `src/components/WSIViewer.tsx`.

##### 5-2. 동기화 모드 진입 시 페이지 비표시(연쇄 업데이트) 수정

- **원인:** syncMode ON 시 effect가 1,2,3번 뷰에 zoomTo/panTo를 호출 → 각 뷰에서 pan/zoom 이벤트 발생 → onPan/onZoom → syncPanFrom/syncZoomFrom이 다시 다른 뷰를 이동 → 반복되어 setState 연쇄 및 "Maximum update depth" 또는 화면 멈춤.
- **조치:** 초기 정렬용 ref `isInitialSyncRef` 추가. effect 진입 시 `true`로 설정, `setTimeout(0)`으로 다음 태스크에서 `false`로 복귀. `syncPanFrom`/`syncZoomFrom`에서 `isInitialSyncRef.current`이면 즉시 return하여 정렬 중 발생하는 pan/zoom 이벤트로 인한 연쇄 동기화 차단.
- **파일:** `src/components/QuadView.tsx`.

##### 6. 타일 서버 OpenSlide 인스턴스 풀

- **기존:** 요청마다 `openslide.OpenSlide(path)`로 열고 사용 후 `close()` → 다중 슬라이드/다중 타일 요청 시 비효율.
- **변경:** 슬라이드(파일 경로)당 인스턴스 풀 도입. `OpenSlidePool`: `acquire(path)`로 풀에서 인스턴스 획득, 사용 후 `release(path, instance)`로 반환. 슬라이드당 최대 `MAX_OPENSLIDE_INSTANCES_PER_SLIDE`(기본 4)개까지 유지. 풀 한도 초과 시 해당 요청만 임시로 열었다 닫기.
- **적용:** `get_slide_info`, `get_tile_bytes`는 `_with_slide(path, use_slide)`를 통해 풀 사용; 풀에 여유가 없으면 일회성 open/close.
- **파일:** `tile-server/app/tile_service.py`.

##### 7. 요약

- 단일 뷰: 기존처럼 WSI 드롭다운 + 하나의 WSIViewer.
- 쿼드뷰: 2×2 패널, 패널마다 작은 드롭다운으로 슬라이드 할당, 닫기 버튼, 동기화 모드 토글. 포커스된 패널만 배율 표시. 동기화 ON이면 좌상단 기준 배율 맞춤 + pan/zoom 시 나머지 뷰에 동일 적용. ref·콜백 안정화로 2개 이상 슬라이드 시에도 OSD 유지.
- 타일 서버: 슬라이드당 OpenSlide 인스턴스 풀 사용으로 동일 슬라이드 반복 요청 시 열기/닫기 비용 감소.
